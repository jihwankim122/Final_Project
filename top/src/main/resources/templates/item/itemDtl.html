<!DOCTYPE html>
<html class="itemDtl"
      layout:decorate="~{layouts/layout1}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">

<head>
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link rel="stylesheet" th:href="@{/css/shop.css}">
</head>


<div layout:fragment="content" style="margin-left:25%;margin-right:25%">

    <input id="itemId" name="itemId" th:value="${item.id}" type="hidden">

    <div class="d-flex">
        <div class="repImgDiv">
            <img class="rounded repImg" th:alt="${item.itemNm}" th:src="${item.itemImgDtoList[0].imgUrl}">
        </div>
        <div class="wd50">
            <!--        1017 은열 수정-->
            <span class="badge badge-primary mgb-15"
                  th:if="${item.itemSellStatus == T(com.top.constant.ItemSellStatus).SELL}">
        판매중
      </span>
            <span class="badge btn-danger mgb-15"
                  th:if="${item.itemSellStatus == T(com.top.constant.ItemSellStatus).SOLD_OUT}">
        품절
      </span>
            <span class="badge badge-secondary mgb-15"
                  th:if="${item.itemSellStatus == T(com.top.constant.ItemSellStatus).DELETE}">
        삭제됨
      </span>
            <div class="h4" th:text="${item.itemNm}"></div>
            <hr class="my-4">

            <div class="text-right">
                <div class="h4 text-danger text-left">
                    <input id="price" name="price" th:value="${item.price}" type="hidden">
                    <span th:text="${item.price}"></span>원
                </div>
                <div class="input-group w-50">
                    <div class="input-group-prepend">
                        <span class="input-group-text">수량</span>
                    </div>
                    <input class="form-control" id="count" min="1" name="count" type="number" value="1">
                </div>
            </div>
            <hr class="my-4">

            <div class="text-right mgt-50">
                <h5>결제 금액</h5>
                <h3 class="font-weight-bold" id="totalPrice" name="totalPrice"></h3>
            </div>
            <div class="text-left" th:if="${item.itemSellStatus == T(com.top.constant.ItemSellStatus).SELL}">
                <button class="btn-buy paybt" onclick="addCart()" type="button">장바구니 담기</button>
                <button class="btn-buy paybt" onclick="order()" type="button">주문하기</button>
            </div>
            <!--        1017은열 수정-->
            <div class="text-right" th:if="${item.itemSellStatus == T(com.top.constant.ItemSellStatus).SOLD_OUT}">
                <button class="btn btn-danger btn-lg" type="button">품절</button>
            </div>
            <div class="text-right" th:if="${item.itemSellStatus == T(com.top.constant.ItemSellStatus).DELETE}">
                <button class="btn btn-danger btn-lg" type="button">삭제</button>
            </div>
        </div>
    </div>

    <div class="jumbotron jumbotron-fluid mgt-30">
        <div class="container">
            <h4 class="display-5">상품 상세 설명</h4>
            <hr class="my-4">
            <p class="lead" th:text="${item.itemDetail}"></p>
        </div>
    </div>

    <div class="text-center" th:each="itemImg : ${item.itemImgDtoList}">
        <img class="rounded mgb-15" th:if="${not #strings.isEmpty(itemImg.imgUrl)}" th:src="${itemImg.imgUrl}"
             width="800">
    </div>
    <button type="button" onclick="location.href='review.html'" class="btn">리뷰 작성</button>
    <div class="list-group reviewList">

    </div>
</div>
<script th:inline="javascript">
    $(document).ready(function(){

        calculateToalPrice();

        $("#count").change( function(){
            calculateToalPrice();
        });
    });

    function calculateToalPrice(){
        var count = $("#count").val();
        var price = $("#price").val();
        var totalPrice = price*count;
        $("#totalPrice").html(totalPrice + '원');
    }

    function order(){
        var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");

        var url = "/order";
        var paramData = {
            itemId : $("#itemId").val(),
            count : $("#count").val()
        };

        var param = JSON.stringify(paramData);

        $.ajax({
            url      : url,
            type     : "POST",
            contentType : "application/json",
            data     : param,
            beforeSend : function(xhr){
                /* 데이터를 전송하기 전에 헤더에 csrf값을 설정 */
                xhr.setRequestHeader(header, token);
            },
            dataType : "json",
            cache   : false,
            success  : function(result, status){
                alert("주문이 완료 되었습니다.");
                location.href='/';
            },
            error : function(jqXHR, status, error){

                if(jqXHR.status == '401'||jqXHR.status == '200'){
                    alert('로그인 후 이용해주세요');
                    location.href='/members/login';
                } else{
                    alert(jqXHR.responseText);
                }

            }
        });
    }

    function addCart(){
        var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");

        var url = "/cart";
        var paramData = {
            itemId : $("#itemId").val(),
            count : $("#count").val()
        };

        var param = JSON.stringify(paramData);

        $.ajax({
            url      : url,
            type     : "POST",
            contentType : "application/json",
            data     : param,
            beforeSend : function(xhr){
                /* 데이터를 전송하기 전에 헤더에 csrf값을 설정 */
                xhr.setRequestHeader(header, token);
            },
            dataType : "json",
            cache   : false,
            success  : function(result, status){
                alert("상품을 장바구니에 담았습니다.");
                location.href='/';
            },
            error : function(jqXHR, status, error){

                if(jqXHR.status == '401'||jqXHR.status == '200'){
                    alert('로그인 후 이용해주세요');
                    location.href='/members/login';
                } else{
                    alert(jqXHR.responseText);
                }

            }
        });
    }

</script>
</th:block>
<script>
    $(document).ready(function(e) {
        //리뷰

        var itemId = document.getElementById('itemId').value; // 아이템 ID 가져오기
        var itemName = document.getElementById('itemName').innerText; // 아이템 이름 가져오기

        // review.html 페이지로 이동하면서 아이템 ID와 이름을 전달
        window.location.href = 'review.html?itemId=' + itemId + '&itemName=' + encodeURIComponent(itemName);

        var grade = 0;
        var id = [[${item.id}]];

        $.ajaxSetup({
            headers: {
                'X-CSRF-TOKEN': $('meta[name="_csrf"]').attr('content')
            }
        });
         $('.starrr').starrr({
             rating: grade,
             change: function(e, value){
                 if (value) {
                     console.log(value);
                     grade = value;
                 }
             }
         });

        //$(".reviewModal").modal("show"); 미리 보기용

        var reviewModal = $(".reviewModal");
        var inputEmail = $('input[name="email"]');
        var inputText = $('input[name="text"]');


        $(".addReviewBtn").click(function () {
            inputEmail.val("");
            inputText.val("");

            $(".removeBtn ,  .modifyBtn").hide();
            $(".reviewSaveBtn").show();

            reviewModal.modal('show');
        });


        $('.reviewSaveBtn').click(function() {
            var id = $("#itemId").val();
            var email = $("#email").val();
            var text = $("#reviewText").val();

            var data = {
                id: id,
                grade: grade,
                text: text,
                email: email
            };

            console.log(data);

            $.ajax({
                url: '/reviews/' + id,
                type: "POST",
                data: JSON.stringify(data),
                contentType: "application/json; charset=utf-8",
                dataType: "text",
                success: function(result) {
                    console.log("result: " + result);
                    // 새로고침하여 변경된 리뷰를 확인
                    self.location.reload();
                }
            });

            reviewModal.modal('hide');
        });


        //페이지가 열리면 바로 리뷰 데이터들을 가져와서 사용한다.
        function getItemReviews() {
            function formatTime(str){
                var date = new Date(str);

                return date.getFullYear() + '/' +
                    (date.getMonth() + 1) + '/' +
                    date.getDate() + ' ' +
                    date.getHours() + ':' +
                    date.getMinutes();
            }
            console.log("id"+id);
            $.ajax({
            url: "/reviews/" + id + "/all", // 요청할 URL
            method: "GET", // 요청 방식
            dataType: "json", // 응답 데이터 타입
            success: function(arr) {
                console.log("??????????????");
                var str = "";

                $.each(arr, function(idx, review) {
                    console.log(review);

                    str += '    <div class="card-body" data-reviewnum=' + review.reviewnum + ' data-email=' + review.email + '>';
                    str += '    <h5 class="card-title">' + review.text + ' <span class="reviewgrade" data-grade2=' + review.grade + '></span></h5>';
                    str += '    <h6 class="card-subtitle mb-2 text-muted">' + review.email + '</h6>';
                    str += '    <p class="card-text">' + formatTime(review.regTime) + '</p>';
                    str += '    </div>';
                });

                $(".reviewList").html(str);
                // 리뷰 별모양으로 나오게하기
                $(".reviewgrade").each(function(idx,o){
                    console.log(o);
                    $(this).starrr({rating:$(this).data("grade2"),readOnly: true});
                });
            }, error: function(xhr, status, error) {
                console.error("Error: " + error);
                console.error("Response Text: " + xhr.responseText);
            }
        });
    }

        //리뷰목록 바로 보이게 하기
        getItemReviews();


        //modify reveiw

        var reviewnum;

        $(".reviewList").on("click", ".card-body", function() {

            $(".reviewSaveBtn").hide();
            $(".removeBtn , .modifyBtn").show();


            var targetReview = $(this);

            reviewnum = targetReview.data("reviewnum");
            console.log("reviewnum: "+ reviewnum);
            inputEmail.val(targetReview.data("email"));
            inputText.val(targetReview.find('.card-title').clone().children().remove().end().text());

            var grade = targetReview.find('.card-title span').html();
            //$(".starrr a:nth-child("+grade+")").trigger('click');

            $('.reviewModal').modal('show');
        });


        $(".modifyBtn").on("click", function(){

            var data = {reviewnum: reviewnum, id:id, grade:grade, text:inputText.val(), email: inputEmail.val() };

            console.log(data);

            $.ajax({
                url:'/reviews/'+id +"/"+ reviewnum ,
                type:"PUT",
                data:JSON.stringify(data),
                contentType:"application/json; charset=utf-8",
                dataType:"text",
                success: function(result){

                    console.log("result: " + result);

                    self.location.reload();

                }
            })
            reviewModal.modal('hide');
        });

        $(".removeBtn").on("click", function(){

            var data = {reviewnum: reviewnum};

            console.log(data);

            $.ajax({
                url:'/reviews/'+id +"/"+ reviewnum ,
                type:"DELETE",
                contentType:"application/json; charset=utf-8",
                dataType:"text",
                success: function(result){

                    console.log("result: " + result);

                    self.location.reload();

                }
            })
            reviewModal.modal('hide');
        });

        $(".uploadResult li").click(function() {

            var file = $(this).data('file');

            console.log(file);

            $('.imageModal .modal-body').html("<img style='width:100%' src='/display?fileName="+file+"&size=1' >")

            $(".imageModal").modal("show");

        });



    });
</script>
</html>